name: Test Secrets & Restart Poly Studio X50

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for restart (for audit note)"
        required: false
        default: "Maintenance"

jobs:
  test-and-restart:
    runs-on: ubuntu-latest

    # Secrets expected:
    #   POLY_DEVICE_IP, POLY_ADMIN_USER, POLY_ADMIN_PASSWORD
    env:
      DEVICE_IP: ${{ secrets.POLY_DEVICE_IP }}
      ADMIN_USER: ${{ secrets.POLY_ADMIN_USER }}

    steps:
      # 1) Validate secrets exist
      - name: Validate secrets
        run: |
          set -e
          if [ -z "${DEVICE_IP}" ]; then
            echo "ERROR: Secret POLY_DEVICE_IP is not set."; exit 1
          fi
          if [ -z "${ADMIN_USER}" ]; then
            echo "ERROR: Secret POLY_ADMIN_USER is not set."; exit 1
          fi
          if [ -z "${{ secrets.POLY_ADMIN_PASSWORD }}" ]; then
            echo "ERROR: Secret POLY_ADMIN_PASSWORD is not set."; exit 1
          fi
          echo "All required secrets are present."

      # 2) Basic connectivity check to device over HTTPS (port 443)
      - name: Connectivity check (TCP/443)
        run: |
          set -e
          echo "Checking HTTPS reachability to ${DEVICE_IP} ..."
          for i in {1..10}; do
            if timeout 2 bash -lc "echo > /dev/tcp/${DEVICE_IP}/443" 2>/dev/null; then
              echo "HTTPS reachable on attempt ${i}"
              exit 0
            fi
            echo "Attempt ${i} failed; retrying..."
            sleep 2
          done
          echo "ERROR: Cannot reach ${DEVICE_IP}:443"
          exit 1

      # 3) Install jq for JSON parsing
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 4) Authenticate to Poly VideoOS (POST /rest/session)
      - name: Authenticate to Poly VideoOS
        id: login
        run: |
          set -euo pipefail
          BODY=$(jq -n --arg u "${ADMIN_USER}" --arg p "${{ secrets.POLY_ADMIN_PASSWORD }}" \
                 '{user:$u,password:$p}')
          RESP=$(curl -sS -k -X POST "https://${DEVICE_IP}/rest/session" \
                     -H "Content-Type: application/json" \
                     --data "${BODY}")
          SESSION_ID=$(echo "${RESP}" | jq -r '.session.sessionId // empty')
          if [ -z "${SESSION_ID}" ] || [ "${SESSION_ID}" = "null" ]; then
            echo "Login response from /rest/session:"
            echo "${RESP}"
            echo "ERROR: Failed to obtain sessionId; check credentials or API access."
            exit 1
          fi
          echo "SESSION_ID=${SESSION_ID}" >> "$GITHUB_OUTPUT"
          echo "Secrets test PASSED: able to authenticate and obtain sessionId."

      # 5) Reboot device (POST /rest/system/reboot)
      - name: Reboot Poly Studio X50
        run: |
          set -euo pipefail
          COOKIE="session_id=${{ steps.login.outputs.SESSION_ID }}"
          PAYLOAD='{"action":"reboot"}'
          HTTP_CODE=$(curl -sS -k -w "%{http_code}" -o /tmp/reboot_resp.json \
            -X POST "https://${DEVICE_IP}/rest/system/reboot" \
            -H "Content-Type: application/json" \
            -H "Cookie: ${COOKIE}" \
            --data "${PAYLOAD}")
          echo "HTTP_CODE=${HTTP_CODE}"
          echo "Response:"; cat /tmp/reboot_resp.json || true
          case "${HTTP_CODE}" in
            200|202) echo "Reboot command accepted by device." ;;
            *)       echo "ERROR: Reboot failed with HTTP ${HTTP_CODE}"; exit 1 ;;
          esac

      # 6) Wait for the device to go down and come back (best-effort)
      - name: Wait for reboot (best-effort)
        continue-on-error: true
        timeout-minutes: 8
        run: |
          set +e
          echo "Waiting for device to go down…"
          for i in {1..30}; do
            if ! timeout 2 bash -lc "echo > /dev/tcp/${DEVICE_IP}/443" 2>/dev/null; then
              echo "HTTPS is down (cycle ${i})"
              break
            fi
            sleep 2
          done
          echo "Waiting for device to come back…"
          for i in {1..120}; do
            if timeout 2 bash -lc "echo > /dev/tcp/${DEVICE_IP}/443" 2>/dev/null; then
              echo "HTTPS up (cycle ${i})"
              exit 0
            fi
            sleep 3
          done
          echo "Note: Device did not return within the wait window; verify manually."

      # 7) Run summary
      - name: Summary
        run: |
          echo "### Poly Studio X50 — Secrets Test + Restart" >> $GITHUB_STEP_SUMMARY
          echo "- Device IP: \`${DEVICE_IP}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Initiated by: \`${GITHUB_ACTOR}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Reason: \`${{ inputs.reason || 'Maintenance' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Result: Login verified and reboot command sent." >> $GITHUB_STEP_SUMMARY
